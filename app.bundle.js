(()=>{"use strict";class e{constructor(e){this.url=e,this.websocket=null}create(e,t){(async e=>{const t=fetch(e.url,{method:e.method,body:JSON.stringify(e.body)}),s=await t;if(!s.ok){const t=JSON.parse(await s.text());return void e.callback(!1,t.message)}const n=await s.json();e.callback(!0,n)})({url:`${this.url}/new-user`,method:"POST",headers:{"Content-Type":"application/json"},body:e,callback:(e,s)=>{e?t(s):alert("Ошибка! Этот псевдоним уже существует. Пожалуйста, выберите другой псевдоним.")}})}exit(e,t){const s={type:"exit",user:{id:e,name:t}};this.websocket.send(JSON.stringify(s))}sendMessage(e,t,s){const n={type:"send",user:{id:t,name:s},msg:e};this.websocket.send(JSON.stringify(n))}}class t{constructor(){this.formElement=document.createElement("div"),this.formElement.className="windows"}static create(){return'\n      <div class="participants window">\n        <ul class="part_list">\n          \n        </ul>\n        <button class=\'button exit\'>Выход</button>\n      </div>\n      <div class="chat window">\n        <ul class="messages"></ul>\n        <input class="input window" placeholder="Type your message here"></input>\n      </div>'}static userCell(e,t){let s=e.name,n="";e.id===t&&(s="You",n="user_info");const r=document.createElement("li");return r.className="user",r.innerHTML=`\n    <span class="avatar"></span>\n    <text class="username ${n}">${s}</text>\n    `,r}}class s{constructor(e,t,s){this.text=e,this.senderData=t,this.currentUserID=s,this.formElement=document.createElement("li"),this.formElement.classList="message"}create(){const e=s.getDate(),t=this.checkUser();let n=this.senderData.name,r="",i="";return t&&(this.formElement.classList.add("user_message"),n="You",r="user_info",i="user_text"),`\n      <div class="blob">\n         <text class="msg_info ${r}">${n}, ${e}</text>\n         <text class="text ${i}">${this.text}</text>\n      </div>\n      `}static getDate(){const e=new Date,t=e.getFullYear().toString().slice(-2),n=s.insertZeroes(e.getMonth()+1);return`${s.insertZeroes(e.getDate())}.${n}.${t} ${s.insertZeroes(e.getHours())}:${s.insertZeroes(e.getMinutes())}`}static insertZeroes(e){let t;return e<10?(t=`0${e}`,t):e}checkUser(){return this.senderData.id===this.currentUserID}}class n{constructor(){this.formElement=document.createElement("div"),this.formElement.className="form"}static create(){return'\n      <h1 class="form_name">Выберите псевдоним</h1>\n      <form class="form_group">\n         <textarea class="name_input"></textarea>\n         <button type=submit class="button confirm">Продолжить</button>\n      </form>'}}const r=document.getElementById("root");new class{constructor(t){this.bindToDOM(t),this.api=new e("https://chat-1xfl.onrender.com"),this.id=null,this.name=null}init(){this.regForm()}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}regForm(){const e=new n;e.formElement.innerHTML=e.constructor.create(),document.body.appendChild(e.formElement),e.formElement.querySelector(".confirm").addEventListener("click",(t=>this.submitUser(t,e)))}submitUser(e,t){if(e.preventDefault(),""===t.formElement.querySelector(".name_input").value)return void alert("Введите псевдоним");const s={name:t.formElement.querySelector(".name_input").value};this.api.create(s,(e=>{this.id=e.user.id,this.name=e.user.name,t.formElement.remove(),this.api.websocket=new WebSocket("wss://chat-1xfl.onrender.com/ws"),this.setChat(),this.registerEvents()}))}setChat(){this.chatArea=new t,this.chatArea.formElement.innerHTML=this.chatArea.constructor.create(),document.querySelector(".windows").appendChild(this.chatArea.formElement)}registerEvents(){const e=document.querySelector(".messages"),t=document.querySelector(".input");document.querySelector(".exit").addEventListener("click",(()=>{this.userExit()})),t.addEventListener("keypress",(e=>{"Enter"===e.key&&t.value&&(this.api.sendMessage(t.value,this.id,this.name),t.value="")})),this.api.websocket.addEventListener("message",(t=>{const s=JSON.parse(t.data);"send"!==s.type?this.renderUsers(s):this.renderMessage(e,s)}))}renderUsers(e){const t=document.querySelector(".part_list");t&&(t.innerHTML="",e.forEach((e=>{const s=this.chatArea.constructor.userCell(e,this.id);t.appendChild(s)})))}userExit(){const e=document.querySelector(".windows");this.api.exit(this.id,this.name),e.innerHTML="",this.init()}renderMessage(e,t){const n=new s(t.msg,t.user,this.id);n.formElement.innerHTML=n.create(),e.appendChild(n.formElement)}}(r).init()})();